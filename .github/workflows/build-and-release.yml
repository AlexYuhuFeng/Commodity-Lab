# .github/workflows/build-and-release.yml
# Commodity Lab è‡ªåŠ¨åŒ–æ„å»ºå’Œå‘å¸ƒå·¥ä½œæµ
# è§¦å‘æ¡ä»¶ï¼šæ ‡ç­¾åˆ›å»º (ä»…é™ v0.*.*ï¼Œé¿å… v1.0.0+ ç”¨äºç”Ÿäº§ç‰ˆ)

name: Build and Release

on:
  push:
    tags:
      - 'v0.*.*'  # å¦‚: v0.1.0ï¼Œä»…æµ‹è¯•ç‰ˆæœ¬è§¦å‘ï¼›é¿å…ä½¿ç”¨ v1.0.0+
  workflow_dispatch:    # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  PYTHON_VERSION: '3.12'
  APP_NAME: 'Commodity-Lab'

permissions:
  contents: write

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install pytest

      - name: Run pytest
        run: |
          python -m pytest -q

  build:
    name: Build Executable
    runs-on: windows-latest  # Windowsç¯å¢ƒï¼Œç”Ÿæˆ.exe
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºç”Ÿæˆchangelog

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build with PyInstaller
        run: |
          if (Test-Path "*.spec") { Remove-Item -Force "*.spec" }
          pyinstaller --onefile --windowed --name "${{ env.APP_NAME }}" `
            --add-data "app:app" `
            --add-data "core:core" `
            --add-data "data:data" `
            --hidden-import=streamlit `
            --hidden-import=duckdb `
            --hidden-import=pandas `
            --hidden-import=plotly `
            --hidden-import=yfinance `
            --collect-all streamlit `
            --distpath dist `
            app/main.py
        shell: pwsh

      - name: Create dist package
        run: |
          cd dist
          Compress-Archive -Path "${{ env.APP_NAME }}.exe" `
            -DestinationPath "${{ env.APP_NAME }}-${{ github.ref_name }}-win64.zip"
          cd ..
        shell: pwsh

      - name: Generate Release Notes
        id: release_notes
        run: |
          $version = "${{ github.ref_name }}"
          $changelog = @"
          ## Commodity Lab $version
          
          ### ğŸ“¦ Version Information
          - **Version**: $version
          - **Release Date**: $(Get-Date -Format 'yyyy-MM-dd')
          - **Platform**: Windows 64-bit
          
          ### ğŸ“¥ Installation
          1. Download: \`Commodity-Lab-$version-win64.zip\`
          2. Extract the ZIP file
          3. Run \`Commodity-Lab.exe\`
          
          ### ğŸ†• What's New
          - See commit history for detailed changes
          
          ### ğŸ”§ System Requirements
          - Windows 7 or later (64-bit)
          - 500MB free disk space
          - Internet connection (for data download)
          
          ### ğŸ“ Release Notes
          This release includes all features from the main branch.
          
          **Build Date**: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
          **Build Number**: ${{ github.run_number }}
          "@

          Write-Output $changelog | Out-File -FilePath RELEASE_NOTES.md -Encoding UTF8
          Write-Output "release_body<<EOF" >> $env:GITHUB_OUTPUT
          Get-Content RELEASE_NOTES.md >> $env:GITHUB_OUTPUT
          Write-Output "EOF" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Create GitHub Release and upload assets (no external actions)
        id: create_release
        run: |
          $ownerRepo = "${{ github.repository }}"
          $token = $env:GITHUB_TOKEN
          $tag = "${{ github.ref_name }}"
          $body = Get-Content -Raw RELEASE_NOTES.md

          $payload = @{ tag_name = $tag; name = $tag; body = $body; draft = $false; prerelease = $false } | ConvertTo-Json -Depth 6
          $headers = @{ Authorization = "token $token"; Accept = 'application/vnd.github+json' }

          $release = Invoke-RestMethod -Uri "https://api.github.com/repos/$ownerRepo/releases" -Method Post -Headers $headers -Body $payload
          $upload_url = $release.upload_url -replace '\{.*$',''

          $zipPath = "dist/${{ env.APP_NAME }}-${{ github.ref_name }}-win64.zip"
          Write-Output "Uploading $zipPath to release $($release.id)"
          $zipName = Split-Path $zipPath -Leaf
          $bytes = [System.IO.File]::ReadAllBytes($zipPath)
          Invoke-RestMethod -Uri "$upload_url?name=$zipName" -Method Post -Headers @{ Authorization = "token $token"; 'Content-Type' = 'application/zip' } -Body $bytes

          $exePath = "dist/${{ env.APP_NAME }}.exe"
          if (Test-Path $exePath) {
            $exeName = Split-Path $exePath -Leaf
            $exeBytes = [System.IO.File]::ReadAllBytes($exePath)
            Invoke-RestMethod -Uri "$upload_url?name=$exeName" -Method Post -Headers @{ Authorization = "token $token"; 'Content-Type' = 'application/octet-stream' } -Body $exeBytes
          } else {
            Write-Warning "Executable not found at $exePath; skipping exe upload."
          }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # tests run in `test` job; build depends on tests to pass before packaging

  notify:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: [build]
    if: success()
    
    steps:
      - name: Create success message
        run: |
          echo "âœ… Build and Release Successful!"
          echo "ğŸ“¦ Release: ${{ github.ref_name }}"
          echo "ğŸ”— URL: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
